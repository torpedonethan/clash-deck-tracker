<!DOCTYPE html>
<html>
<head>
  <title>Clash Royale Winrate Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 40px;
    }
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h2>Clash Royale Deck Winrate Over Time</h2>
  <p id="loadingMsg">📊 Loading match data from Google Sheets...</p>
  <canvas id="winrateChart" width="800" height="400"></canvas>

  <script>
    const sheetCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpyqq4G-Qws8883zcFhP8wgBkeGaKCS-JAoVLGDBuezKMoDCrs5Lp5gnnuo70osVrIxF4HVl2n-jFb/pub?output=csv';

    Papa.parse(sheetCSV, {
      download: true,
      header: true,
      complete: function(results) {
        const data = results.data;
        console.log("CSV data loaded:", data);

        const deckGroups = {};
        data.forEach(match => {
          const deck = match.deck_hash;
          const timestampStr = match.timestamp;

          // Parse ISO-like timestamp format (e.g. 20250420T220228.000Z)
          const ts = new Date(
            timestampStr.replace(
              /^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/,
              '$1-$2-$3T$4:$5:$6'
            )
          );

          const win = match.result?.toLowerCase() === 'win' ? 1 : 0;
          if (!deck || isNaN(ts)) return;

          if (!deckGroups[deck]) deckGroups[deck] = [];
          deckGroups[deck].push({ ts, win });
        });

        if (Object.keys(deckGroups).length === 0) {
          document.getElementById("loadingMsg").innerText = "⚠️ No valid match data found.";
          return;
        }

        const chartData = {
          labels: [],
          datasets: []
        };

        Object.keys(deckGroups).forEach((deck, i) => {
          const matches = deckGroups[deck].sort((a, b) => a.ts - b.ts);
          let wins = 0;
          const points = matches.map((m, idx) => {
            wins += m.win;
            return ((wins / (idx + 1)) * 100).toFixed(2); // percent
          });

          chartData.datasets.push({
            label: `Deck ${deck.slice(0, 6)}`,
            data: points,
            fill: false,
            borderColor: `hsl(${i * 60 % 360}, 70%, 50%)`,
            tension: 0.3
          });

          if (chartData.labels.length < matches.length) {
            chartData.labels = matches.map(m => {
              const d = new Date(m.ts);
              return `${d.getMonth() + 1}/${d.getDate()}/${String(d.getFullYear()).slice(-2)}`;
            });
          }
        });

        const ctx = document.getElementById('winrateChart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: chartData,
          options: {
            responsive: true,
            plugins: {
              legend: { display: true }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                title: { display: true, text: 'Win Rate (%)' }
              },
              x: {
                title: { display: true, text: 'Date' }
              }
            }
          }
        });

        document.getElementById("loadingMsg").style.display = "none";
      }
    });
  </script>
</body>
</html>
